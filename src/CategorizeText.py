import requests
import pandas as pd
from pathlib import Path

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
file_path = r"C:\Users\Igor\Downloads\–¥–∞—Ç–∞—Å–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤\2.csv"
output_path = file_path

# –ë–∞–∑–æ–≤—ã–π prompt
base_prompt = '''
–ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –∫ –æ–¥–Ω–æ–π –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Ç–µ–º–∞—Ç–∏–∫–∞–º –∏–∑ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–°–ø–æ—Ä—Ç, –Æ–º–æ—Ä, –†–µ–∫–ª–∞–º–∞, –°–æ—Ü—Å–µ—Ç–∏, –ü–æ–ª–∏—Ç–∏–∫–∞, –õ–∏—á–Ω–∞—è –∂–∏–∑–Ω—å) 
–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –Ω–∏–∂–µ –ø—Ä–∏–º–µ—Ä–∞–º–∏.
–ü—Ä–∏–º–µ—Ä 1:
–ü–∏–Ω—è–µ–≤, –≤–æ, "–ö–∞–∫–æ–π –ø–µ–Ω—è–µ–≤ —Ö–æ—Ä–æ—à–∏–π, –∞! –ò –í–æ—Ä–æ–±—å–µ–≤! –í—Ç–æ—Ä–æ–π –º–∞—Ç—á, –≤—Ç–æ—Ä–æ–π –≥–æ–ª! –°—É–ø–µ—Ä, –∞! –£—Ñ!" –°–ø–æ—Ä—Ç: 1.0
–ü—Ä–∏–º–µ—Ä 2:
–ù–µ–¥–∞–≤–Ω–æ –º—ã —Å –∂–µ–Ω–æ–π —Ö–æ–¥–∏–ª–∏ –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç –≥—Ä—É–ø–ø—ã ¬´32nd to Mars¬ª –∏ ¬´–î–∂–∞—Ä–¥–∞ –õ–µ—Ç–∞¬ª. –ë–∏–ª–µ—Ç—ã –Ω–∞ —ç—Ç–æ—Ç –∫–æ–Ω—Ü–µ—Ä—Ç —è –ø–æ–¥–∞—Ä–∏–ª –∂–µ–Ω–µ –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è. –í–ø–µ—Ä–≤—ã–µ –≤ –∂–∏–∑–Ω–∏ —É–≥–∞–¥–∞–ª —Å –ø–æ–¥–∞—Ä–∫–æ–º. –õ–∏—á–Ω–∞—è –∂–∏–∑–Ω—å: 1.0
–ü—Ä–∏–º–µ—Ä 3:
–∫–æ–º–∏–∫ , –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–∂–∏–ª –∏ –æ—Å–æ–∑–Ω–∞–ª —ç—Ç—É –∂–∏–∑–Ω—å ‚Äì –°—Ç–∞—Å –°—Ç–∞—Ä–æ–≤–æ–π—Ç–æ–≤  –ò—â–∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å–µ–≥–æ–¥–Ω—è –≤ –ù–û–í–û–ú –°–ï–ó–û–ù–ï ¬´ —Å—Ç–µ–Ω–¥–∞–ø ¬ª –≤ 23:00 –Ω–∞ –¢–ù–¢"	–Æ–º–æ—Ä: 1.0
–ü—Ä–∏–º–µ—Ä 4:
–ö–ê–ö–ê–Ø –ö–ê–†–¢–ê –£–ö–ê–ñ–ï–¢ –ù–ê –ú–ê–°–ò–ö–ê?  –†–ê–°–ü–†–û–î–ê–ñ–ê –ö–£–†–°–ê ¬´–û–†–ê–ö–£–õ –õ–ï–ù–û–†–ú–ê–ù. –ë–ê–ó–û–í–´–ô –ö–£–†–°¬ª –í –†–ê–°–°–†–û–ß–ö–£	–†–µ–∫–ª–∞–º–∞: 1.0
–ü—Ä–∏–º–µ—Ä 5:
–ü—Ä–∏–≥–ª–∞—à–∞—é –≤—Å–µ–π –≤ —Å–≤–æ–µ –í–ö —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, –±—É–¥–µ–º –¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º –∏ —Ç—Ä–∞–≤–∏—Ç—å –±–∞–π–∫–∏!	–°–æ—Ü—Å–µ—Ç–∏: 1.0
–ü—Ä–∏–º–µ—Ä 6:
–°–µ–≥–æ–¥–Ω—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –≤—Å—Ç—Ä–µ—á–∞ –ø—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –≥–æ—Å–¥—É–º—ã –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π —Ä–µ–≥–∏–æ–Ω–æ–≤	–ü–æ–ª–∏—Ç–∏–∫–∞: 1.0
–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ä–∞–∑–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —Ç–æ –ø–∏—à–∏ —á–µ—Ä–µ–∑ —á–µ—Ä—Ç–æ—á–∫—É: –°–æ—Ü—Å–µ—Ç–∏: 0.5/–ü–æ–ª–∏—Ç–∏–∫–∞: 0.5.
–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –Ω–∏ –∫ –æ–¥–Ω–æ–π –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –ø–∏—à–∏: –ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
–ü—Ä–∏ —ç—Ç–æ–º —Å—É–º–º–∞—Ä–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 1.0. 
–¢–µ–ø–µ—Ä—å –æ–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
'''

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Ollama
url = "http://192.168.17.1:11434/api/generate"
model_name = "qwen2.5:32b"

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
df = pd.read_csv(file_path)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
if 'response' not in df.columns:
    df['response'] = ""

# –ü–æ–¥—Å—á–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö
processed_since_last_save = 0

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫
for i, row in df.iterrows():
    # –ü—Ä–æ–ø—É—Å–∫ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
    if isinstance(df.at[i, 'response'], str) and df.at[i, 'response'].strip():
        print(f"‚è≠Ô∏è –°—Ç—Ä–æ–∫–∞ {i + 1} —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.")
        continue

    # –ö–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ (–∫—Ä–æ–º–µ response) –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
    text_parts = []
    for col in df.columns:
        if col != 'response' and pd.notna(row[col]):
            text_parts.append(str(row[col]))
    text = ' '.join(text_parts).strip()

    if not text:
        print(f"‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ {i + 1} –ø—É—Å—Ç–∞—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.")
        continue

    full_prompt = f"{base_prompt}\n\n{text}"
    payload = {
        "model": model_name,
        "prompt": full_prompt,
        "stream": False
    }

    print(f"üß† –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–æ–∫–µ {i + 1}...")

    try:
        response = requests.post(url, json=payload, timeout=60)
        if response.status_code == 200:
            generated = response.json()["response"]
            df.at[i, 'response'] = generated
            print(f"‚úÖ –û—Ç–≤–µ—Ç –∑–∞–ø–∏—Å–∞–Ω –≤ —Å—Ç—Ä–æ–∫—É {i + 1}")
            print(df.at[i, 'response'])
            processed_since_last_save += 1

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å—Ç—Ä–æ–∫
            if processed_since_last_save >= 10:
                df.to_csv(output_path, index=False)
                print("üíæ –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.")
                processed_since_last_save = 0

        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ({response.status_code}): {response.text}")
            # –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            df.to_csv(output_path, index=False)
            print("üíæ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")
    except Exception as e:
        print(f"‚ùó –û—à–∏–±–∫–∞ —Å—Ç—Ä–æ–∫–∏ {i + 1}: {e}")
        # –ü—Ä–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        df.to_csv(output_path, index=False)
        print("üíæ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.")

# –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
df.to_csv(output_path, index=False)
print(f"\n‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {output_path}")